{% extends 'base.html' %}
{% block title %}Panel Administratora{% endblock %}
{% block content %}
    <!-- SEKCJA DODAWANIA SZABLONU -->
    <div class="section-container">
        <h2>Dodaj nowy szablon</h2>
        <form action="{{ url_for('add_template') }}" method="post" enctype="multipart/form-data" class="form-section">
            <div class="form-group">
                <label for="template_name_upload">Nazwa szablonu (wymagane):</label>
                <input type="text" id="template_name_upload" name="template_name" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="template_file_upload">Plik szablonu .xlsx (wymagane):</label>
                <input type="file" id="template_file_upload" name="template_file" class="form-control-file" accept=".xlsx" required>
            </div>

            <hr>
            <h3>Mapowanie komórek i Numeracja</h3>
            <p class="info-message">Wypełnij adresy komórek i zaznacz, które pola mają być wymagane dla użytkownika.</p>

            {% for field in fields_to_map %}
            <div class="form-group form-row align-items-center">
                <label class="col-sm-3 col-form-label">{{ field.replace('_', ' ').title() }}:</label>
                <div class="col-sm-5">
                    <input type="text" name="mapping_{{ field }}" class="form-control" placeholder="np. A1" {% if field == 'imie_nazwisko' %}required{% endif %}>
                </div>
                <div class="col-sm-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_required_{{ field }}" id="is_required_{{ field }}_create">
                        <label class="form-check-label" for="is_required_{{ field }}_create">Wymagane</label>
                    </div>
                </div>
            </div>
            {% endfor %}

            <div id="custom-fields-container"></div>
            <button type="button" id="add-custom-field-btn" class="btn btn-secondary mt-2 mb-3">Dodaj własne pole</button>

            <div class="form-group mt-4">
                <label for="numbering_format_create">Format numeracji certyfikatów:</label>
                <input type="text" name="numbering_format" id="numbering_format_create" class="form-control" placeholder="Domyślnie: {NUMER}/{MIESIAC}/{ROK}" value="{NUMER}/{MIESIAC}/{ROK}">
                <small class="form-text text-muted">
                    Dostępne znaczniki: {NUMER}, {NUMER_STARTOWY}, {ROK}, {RR}, {MIESIAC}, {DZIEN}, {ID_UZYTKOWNIKA}, {LOGIN_UZYTKOWNIKA}
                </small>
            </div>

            <hr>
            <button type="submit" class="btn btn-primary">Dodaj szablon</button>
        </form>
    </div>

    <hr>

    <!-- SEKCJA LISTY SZABLONÓW (TERAZ JAKO TABELA ZE STATYSTYKAMI) -->
    <div class="section-container">
        <h2>Istniejące szablony</h2>
        {% if templates %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>Nazwa Szablonu</th>
                        <th>Przypisani użytkownicy</th>
                        <th class="text-center" title="Ile razy kliknięto 'Generuj'">Użycia</th>
                        <th class="text-center" title="Łączna liczba wygenerowanych certyfikatów">Wydano (szt)</th>
                        <th class="text-right">Akcje</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in templates %}
                    <tr>
                        <!-- Nazwa i Plik -->
                        <td class="align-middle">
                            {{ t.name }}
                        </td>

                        <!-- Przypisani użytkownicy -->
                        <td class="align-middle">
                            {% if t.assigned_users.count() > 0 %}
                                <div style="max-height: 60px; overflow-y: auto;">
                                {% for user in t.assigned_users %}
                                    <span class="badge badge-pill badge-info">{{ user.username }}</span>
                                {% endfor %}
                                </div>
                            {% else %}
                                <span class="text-muted small">Brak przypisanych</span>
                            {% endif %}
                        </td>

                        <!-- STATYSTYKI (Nowe kolumny) -->
                        <td class="align-middle text-center">
                            <span class="badge badge-light border">{{ t.usage_count }}</span>
                        </td>
                        <td class="align-middle text-center">
                            {% if t.total_certificates_generated > 0 %}
                                <span class="badge badge-success">{{ t.total_certificates_generated }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>

                        <!-- Przyciski Akcji -->
                        <td class="align-middle text-right">
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('edit_template', template_id=t.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-edit"></i> Edytuj
                                </a>
                                <form class="d-inline ml-1" action="{{ url_for('delete_template', template_id=t.id) }}" method="post" onsubmit="return confirm('Czy na pewno usunąć szablon {{ t.name }}?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash"></i> Usuń
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="info-message">Nie ma jeszcze żadnych szablonów w systemie.</p>
        {% endif %}
    </div>
{% endblock %}